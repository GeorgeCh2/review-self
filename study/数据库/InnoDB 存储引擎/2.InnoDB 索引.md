# 索引
索引优化是对查询性能优化的最有效手段
## InnoDB 存储引擎索引
支持的索引：
* B+ 树索引  
  B+ 树是为磁盘或其他直接存取辅助设备设计的一种平衡查找树。在 B+ 树中，所有记录节点都是按键值的大小顺序存放在同一层的叶子节点上，由各叶子节点指针进行连接。
* 全文索引
* 哈希索引
### 索引的数据结构
InnoDB 存储引擎在绝大多数情况下使用 B+ 树建立索引，B+ 树索引并不能找到一个给定键对应的具体值，它只能找到数据行对应的页，数据库把整个页读入到内存中，并在内存中查找具体的数据行。
### 聚集索引和辅助索引
数据库中的 B+ 树索引可以分为聚集索引（clustered index）和辅助索引（secondary index），它们之间最大区别就是，聚集索引中存放着一条行记录的全部信息，而辅助索引中只包含索引列和一个用于查找对应行记录的「书签」。
#### 聚集索引
InnoDB 存储引擎中的表都是使用索引组织的，也就是按照键的顺序存放；聚集索引就是按照表中主键的顺序构建一颗 B+ 树，并在叶节点中存放表中的行记录数据。  
聚集索引与表的物理存储方式有着非常密切的关系，所有正常的表应该有且仅有一个聚集索引（绝大多数情况下都是主键），表中的所有行记录数据都是按照聚集索引的顺序存放的。  
当使用聚集索引对表中的数据进行检索时，可以直接获得聚集索引所对应的整条行记录数据所在的页，不需要进行第二次操作。
#### 辅助索引
数据库将所有非聚集索引都划分为辅助索引；辅助索引也是通过 B+ 树实现的，但是它的叶节点并不包含行记录的全部数据，仅包含索引中的所有键和一个用于查找对应行记录的「书签」，在 InnoDB 中这个书签就是当前记录的主键。  
辅助索引的存在并不会影响聚集索引，辅助索引只用于加速数据的查找，一张表上往往有多个辅助索引以此来提升数据库的性能。  
使用辅助索引查找一条记录的过程：通过辅助索引查找到对应的主键，最后在聚集索引中使用主键获取对应的行记录。
## Cardinality 值
并不是在所有的查询条件中出现的列都需要添加索引。列的可取值范围很广时（高选择性）使用 B+ 树索引是最适合的。  
Cardinality 值表示索引中不重复记录数量的预估值，Cardinality/n_rows_in_table 应尽可能接近1.

## B+ 树索引的使用
### 联合索引
联合索引是指对表上的多个列进行索引。  
联合索引也是一颗 B+ 树，但是键值的数量大于等于 2。  
联合索引已经对第二个键值进行了排序处理，如果查询需要通过第二个键值排序，则可以通过联合索引避免一次排序操作。
### 覆盖索引
覆盖索引（covering index，或称索引覆盖），即从辅助索引中就可以得到查询的记录，而不需要查询聚集索引中的记录。  
辅助索引不包含整行记录的所有信息，故其大小要远小于聚集索引，因此可以减少大量的 IO 操作。
### Multi-Range Read 优化
MRR 的工作方式：
* 将查询得到的辅助索引键值存放于一个缓存中，这时缓存中的数据是根据辅助索引键值排序的
* 将缓存中的键值根据 RowID 进行排序
* 根据 RowID 的排序顺序来访问实际的数据文件  
MRR 的好处：
* 使数据访问变得较为顺序
* 减少缓冲池中页被替换的次数
* 批量处理对键值的查询操作
### Index Condition Pushdown（ICP）优化
工作方式：取出索引的同时，判断是否可以进行 WHERE 条件的过滤，将 WHERE 的部分过滤操作放在了存储引擎层。

## 通过哈希算法优化性能
虽然内存中查询速度很快，但是也不可能每次都有遍历所有内存来进行查找，通过哈希算法可以将时间复杂度降低为 O(1)
### InnoDB 存储引擎中的哈希算法
InnoDB 存储引擎使用哈希算法来对字典进行查找，冲突机制采用链表方式，哈希函数采用除法散列
### 自适应哈希索引
自适应哈希索引经哈希函数映射到一个哈希表中，对于字典类型的查找非常快速，但不适应于范围查找
